<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Card Pack Opener</title>
<style>
body {
    font-family: Arial;
    background:#121212;
    color:#fff;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:20px;
    overflow-x:hidden;
}

#top-bar {
    display:flex;
    gap:30px;
    align-items:center;
    font-size:18px;
    margin-bottom:20px;
}
#top-bar img { width:24px; height:24px; vertical-align:middle; margin-right:5px; }

.pack {
    width:200px;
    height:300px;
    margin:20px;
    cursor:pointer;
    border-radius:10px;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    align-items:center;
    border:2px solid #fff;
    transition: transform 0.3s ease;
}
.pack:hover { transform: scale(1.05); }
.pack.disabled { pointer-events:none; opacity:0.5; }
.pack img { width:100%; height:80%; object-fit:contain; }
.pack-price { width:100%; text-align:center; background:#222; padding:5px; font-weight:bold;}

#animation-container {
    position:fixed;
    bottom:-350px;
    left:50%;
    transform:translateX(-50%);
    width:200px;
    height:300px;
    pointer-events:none;
    z-index:1000;
}
#animation-container img {
    width:100%;
    height:100%;
    border-radius:10px;
    object-fit:contain;
    transform-origin:top center;
    backface-visibility:hidden;
}

#card-display {
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%) scale(0);
    width:200px;
    height:300px;
    border-radius:10px;
    z-index:1001;
    transition: transform 0.6s ease, box-shadow 0.6s ease;
}
#card-display img {
    width:100%;
    height:100%;
    border-radius:10px;
    object-fit:contain;
}
#rarity-bar {
    position:absolute;
    bottom:0;
    width:100%;
    padding:5px;
    text-align:center;
    font-weight:bold;
    border-bottom-left-radius:8px;
    border-bottom-right-radius:8px;
}

/* INVENTORY */
#inventory {
    margin-top:30px;
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
}
.inventory-card {
    display:inline-block;
    margin:10px;
    position:relative;
    width:120px;
    transition: transform 0.2s ease;
}
.inventory-card:hover { transform: scale(1.08); }
.inventory-card img {
    width:120px;
    height:180px;
    border-radius:8px;
    display:block;
}
.inventory-card .card-name {
    text-align:center;
    padding:3px;
    font-weight:bold;
    border-radius:0 0 8px 8px;
    margin-top:-5px;
}

/* SMALL SELL BUTTON TOP-RIGHT */
.sell-btn {
    position:absolute;
    top:6px;
    right:6px;
    padding:2px 5px;
    font-size:12px;
    border:none;
    border-radius:4px;
    background:#ff5555cc;
    color:#fff;
    cursor:pointer;
    transition: transform 0.2s ease, background 0.2s ease;
}
.sell-btn:hover {
    transform: scale(1.2);
    background:#ff4444;
}

/* PRICE UNDER BUTTON */
.sell-price {
    position:absolute;
    top:28px;
    right:4px;
    background:#000c;
    font-size:11px;
    padding:2px 6px;
    border-radius:6px;
    display:flex;
    align-items:center;
    gap:3px;
}

#packs-container {
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
}

/* SPARKLE EFFECT */
@keyframes sparkle {
    0% { transform: scale(0.5) rotate(0deg); opacity:0; }
    50% { transform: scale(1.0) rotate(180deg); opacity:1; }
    100% { transform: scale(0.7) rotate(360deg); opacity:0; }
}
.sparkle {
    position: absolute;
    width: 15px;
    height: 15px;
    background: radial-gradient(circle, #fff, #ff0, transparent);
    border-radius: 50%;
    animation: sparkle 1s ease-out forwards;
    pointer-events:none;
}
</style>
</head>
<body>

<h1>Card Pack Opener</h1>
<div id="top-bar">
  <div id="tokens"><img src="https://www.wtfq.online/Tokens/token.png">Tokens: 5</div>
  <div id="coins"><img src="https://www.wtfq.online/Tokens/coin.png">Coins: 0</div>
</div>

<div id="packs-container"></div>
<div id="animation-container"></div>

<div id="card-display">
    <img id="card-img" src="" alt="Card">
    <div id="rarity-bar"></div>
</div>

<h2>Inventory</h2>
<div id="inventory"></div>

<script>
const rarities = ['Common','Uncommon','Rare','Epic','Legendary','Divine'];
const packPrices = { 'Common':1,'Uncommon':2,'Rare':3,'Epic':5,'Legendary':8,'Divine':12 };
const rarityColors = { 'Common':'gray','Uncommon':'green','Rare':'blue','Epic':'purple','Legendary':'orange','Divine':'red' };

let tokens = safeParseCookie('tokens',5);
let coins = safeParseCookie('coins',0);
let inventory = safeParseCookie('inventory',[]);

updateTokens(); updateCoins(); updateInventory();

const packsContainer = document.getElementById('packs-container');
const animationContainer = document.getElementById('animation-container');
const cardDisplay = document.getElementById('card-display');
const cardImg = document.getElementById('card-img');
const rarityBar = document.getElementById('rarity-bar');

const rarityLevels = { 'Common':0, 'Uncommon':1, 'Rare':2, 'Epic':3, 'Legendary':4, 'Divine':5 };
const levelRarities = ['Common','Uncommon','Rare','Epic','Legendary','Divine'];

// CREATE PACK BUTTONS
rarities.forEach(rarity=>{
    const packDiv = document.createElement('div');
    packDiv.className='pack';

    const packImg = document.createElement('img');
    packImg.src = `${rarity}.png`; 
    packImg.alt = `${rarity} Pack`;
    packImg.onerror = function(){ this.style.backgroundColor = rarityColors[rarity]; this.src=''; };
    packDiv.appendChild(packImg);

    const priceDiv = document.createElement('div');
    priceDiv.className = 'pack-price';
    priceDiv.textContent = `Cost: ${packPrices[rarity]} Tokens`;
    packDiv.appendChild(priceDiv);

    packDiv.onclick = ()=>openPackAnimation(rarity);
    packsContainer.appendChild(packDiv);
});

// RANDOM RARITY FUNCTION
function getRandomRarity(baseRarity) {
    const baseLevel = rarityLevels[baseRarity];
    let roll = Math.random()*100; // 0-100%

    // Common pack probabilities example
    let thresholds = [];
    switch(baseRarity) {
        case 'Common': thresholds = [84,94,98,99,99.9,100]; break;
        case 'Uncommon': thresholds = [0,85,95,99,99.9,100]; break;
        case 'Rare': thresholds = [0,0,85,95,99,100]; break;
        case 'Epic': thresholds = [0,0,0,85,95,100,100]; break;
        case 'Legendary': thresholds = [0,0,0,0,90,100]; break;
        case 'Divine': thresholds = [0,0,0,0,10,100]; break;
    }
    for(let i=baseLevel;i<=5;i++){
        if(roll < thresholds[i]) return levelRarities[i];
    }
    return baseRarity; // fallback
}

// OPEN PACK ANIMATION
async function openPackAnimation(rarity){
    const price = packPrices[rarity];
    if(tokens < price){ alert('Not enough tokens!'); return; }
    tokens -= price; updateTokens();

    document.querySelectorAll('.pack').forEach(p=>p.classList.add('disabled'));

    const cardsList = await fetch('cards/cards.json').then(r=>r.json());

    // pick 1 card
    let cardRarity = getRandomRarity(rarity);
    const availableCards = cardsList.filter(c=>c.rarity===cardRarity);
    let card;
    if(availableCards.length>0){
        card = availableCards[Math.floor(Math.random()*availableCards.length)];
    } else {
        // fallback: pick base rarity card if none exist
        const fallback = cardsList.filter(c=>c.rarity===rarity);
        card = fallback[Math.floor(Math.random()*fallback.length)];
    }

    // animation
    animationContainer.innerHTML = `<img src='${rarity}.png'>`;
    animationContainer.style.bottom = '-350px';
    animationContainer.style.display = 'block';
    animationContainer.firstChild.style.transform = 'rotateX(0deg)';

    let pos=-350;
    const slideUp = setInterval(()=>{
        pos += 15;
        animationContainer.style.bottom = pos+'px';
        if(pos>=50){ clearInterval(slideUp); flipPack(card); }
    },10);
}

function flipPack(card){
    const img = animationContainer.firstChild;
    img.style.transition='transform 0.6s ease';
    img.style.transform='rotateX(90deg)';
    setTimeout(()=>{
        animationContainer.style.display='none';
        revealCard(card);
        inventory.push(card);
        setCookie('inventory',inventory);
        updateInventory();
        document.querySelectorAll('.pack').forEach(p=>p.classList.remove('disabled'));
    },600);
}

// CARD REVEAL
function revealCard(card){
    cardImg.src = `cards/${card.image}`;
    rarityBar.textContent = card.name;
    rarityBar.style.backgroundColor = rarityColors[card.rarity];
    cardDisplay.style.transform = 'translate(-50%,-50%) scale(1)';
    cardDisplay.style.boxShadow = `0 0 30px 10px ${rarityColors[card.rarity]}`;

    // sparkles
    for(let i=0;i<15;i++){
        const sparkle = document.createElement('div');
        sparkle.className='sparkle';
        sparkle.style.left = Math.random()*200+'px';
        sparkle.style.top = Math.random()*300+'px';
        sparkle.style.width = (10+Math.random()*10)+'px';
        sparkle.style.height = sparkle.style.width;
        cardDisplay.appendChild(sparkle);
        setTimeout(()=> sparkle.remove(),1000);
    }

    setTimeout(()=>{
        cardDisplay.style.transform = 'translate(-50%,-50%) scale(0)';
        cardDisplay.style.boxShadow = 'none';
    },2000);
}

// COOKIE HELPERS
function safeParseCookie(name,defaultValue){
    const v=document.cookie.split('; ').find(r=>r.startsWith(name+'='));
    if(v) try{ return JSON.parse(v.split('=')[1]); }catch(e){ return defaultValue; }
    return defaultValue;
}
function setCookie(name,value){ document.cookie = `${name}=${JSON.stringify(value)}; path=/`; }

function updateTokens(){ 
    document.getElementById('tokens').innerHTML=`<img src='https://www.wtfq.online/Tokens/token.png'>Tokens: ${tokens}`; 
}
function updateCoins(){ 
    document.getElementById('coins').innerHTML=`<img src='https://www.wtfq.online/Tokens/coin.png'>Coins: ${coins}`; 
}

// UPDATE INVENTORY
function updateInventory(){
    const inv = document.getElementById('inventory'); 
    inv.innerHTML='';

    inventory.forEach((card,index)=>{
        const div = document.createElement('div'); 
        div.className='inventory-card';
        div.innerHTML = `
            <img src='cards/${card.image}'>
            <div class='card-name' style='background:${rarityColors[card.rarity]}'>${card.name}</div>
            <button class='sell-btn' onclick='sellCard(${index})'>Sell</button>
            <div class='sell-price'>${card.coinWorth||1} Coins</div>
        `;
        inv.appendChild(div);
    });
}

// SELL FUNCTION
function sellCard(index){ 
    const card = inventory[index]; 
    coins += card.coinWorth||1; 
    setCookie('coins',coins); 
    inventory.splice(index,1); 
    setCookie('inventory',inventory); 
    updateCoins(); 
    updateInventory(); 
}
</script>
</body>
</html>
